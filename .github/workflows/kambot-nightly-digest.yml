name: kambot nightly digest
on:
  schedule:
    - cron: '0 2 * * *'  # 2:00 UTC daily
jobs:
  digest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Generate digest from TASKS.md
        run: |
          mkdir -p brain/digests
          DATE=$(date -u +%Y-%m-%d)
          echo "# Kambot Nightly Digest - $DATE" > brain/digests/digest-$DATE.md
          echo "\n## Tasks\n" >> brain/digests/digest-$DATE.md
          if [ -f tasks/TASKS.md ]; then
            # extract task headers
            awk '/^---$/ {inblock=!inblock; next} inblock && /^id:/ {id=$2} inblock && /^title:/ {title=substr($0,index($0,$2))} inblock && /^priority:/ {pri=$2} inblock && /^status:/ {st=$2} inblock && /^owner:/ {own=$2} /^---$/ {print id" | "title" | "pri" | "st" | "own"'}' tasks/TASKS.md > /tmp/tasks_list.txt || true
            if [ -s /tmp/tasks_list.txt ]; then
              echo "ID | Title | Priority | Status | Owner" >> brain/digests/digest-$DATE.md
              echo "---|---|---|---|---" >> brain/digests/digest-$DATE.md
              cat /tmp/tasks_list.txt >> brain/digests/digest-$DATE.md
            else
              echo "No tasks found in TASKS.md." >> brain/digests/digest-$DATE.md
            fi
          else
            echo "TASKS.md not found." >> brain/digests/digest-$DATE.md
          fi
      - name: Commit digest
        run: |
          git config user.name "kambot-bot"
          git config user.email "kambot@example.com"
          git add brain/digests/digest-*.md
          git commit -m "kambot nightly digest seed ($DATE)" || true
          git push origin main || true
